import glob
import subprocess


loc = "/etc/hyperledger/peer-scripts/"

def set_up_dilithium():
    # KEY GEN
    try:
        dilithium_c_files = glob.glob(f"{loc}dilithium/dilithium/ref/*.c")
        command = ["gcc", "-o", f"{loc}dilithium/get_key_gen", f"{loc}dilithium/get_key_gen.c"] + dilithium_c_files + [f"-I{loc}dilithium/dilithium/ref", "-std=c99"]
        result = subprocess.run(command, capture_output=True, text=True, check=True)

        print("STDOUT:", result.stdout)
        print("STDERR:", result.stderr)
    # DEBUGS
    except subprocess.CalledProcessError as e:
        print("Compilation failed.")
        print("STDOUT:", e.stdout)
        print("STDERR:", e.stderr)
        return False

    except Exception as e:
        print("Unexpected error at key gen:", e)
        print(e)
        return False

    # SIGN
    try:
        dilithium_c_files = glob.glob(f"{loc}dilithium/dilithium/ref/*.c")
        command = ["gcc", "-o", f"{loc}dilithium/get_sign", f"{loc}dilithium/get_sign.c"] + dilithium_c_files + [f"-I{loc}dilithium/dilithium/ref", "-std=c99"]
        result = subprocess.run(command, capture_output=True, text=True, check=True)

        print("STDOUT:", result.stdout)
        print("STDERR:", result.stderr)
    # DEBUGS
    except subprocess.CalledProcessError as e:
        print("Compilation failed.")
        print("STDOUT:", e.stdout)
        print("STDERR:", e.stderr)
        return False

    except Exception as e:
        print("Unexpected error:", e)
        print(e)
        return False
    
    # VERIFY
    try:
        dilithium_c_files = glob.glob(f"{loc}dilithium/dilithium/ref/*.c")
        command = ["gcc", "-o", f"{loc}dilithium/get_verify", f"{loc}dilithium/get_verify.c"] + dilithium_c_files + [f"-I{loc}dilithium/dilithium/ref", "-std=c99"]
        result = subprocess.run(command, capture_output=True, text=True, check=True)

        print("STDOUT:", result.stdout)
        print("STDERR:", result.stderr)
    # DEBUGS
    except subprocess.CalledProcessError as e:
        print("Compilation failed.")
        print("STDOUT:", e.stdout)
        print("STDERR:", e.stderr)
        return False

    except Exception as e:
        print("Unexpected error:", e)
        print(e)
        return False

    return True

def key_gen():
    try: 
        command = [f"./{loc}dilithium/get_key_gen"]
        result = subprocess.run(command, capture_output=True, text=True, check=True)
        pk = str(result).split("\\n")[1]
        sk = str(result).split("\\n")[4]
        # print(pk)
        # print(sk)
        return pk, sk
    except:
        print("failed to create executable file for key_gen.")
        return False

def sign(message, sk):
    try: 
        command = [f"./{loc}dilithium/get_sign", message, sk]
        result = subprocess.run(command, capture_output=True, text=True, check=True)
        # for i, l in enumerate(str(result).split("\\n")): print((i, l))    
        signature = str(result).split("\\n")[1]
        print(signature)
        return signature        
    except Exception as e:
        print(e)
        print("failed to create executable file for signature.")
        return False

def verify(message, signature, pk):
    try: 
        command = [f"./{loc}dilithium/get_verify", message, signature, pk]
        result = subprocess.run(command, capture_output=True, text=True, check=True)
        for i, l in enumerate(str(result).split("\\n")): print((i, l))    
        # signature = str(result).split("\\n")[1]
        # print(result)
        return result        
    except Exception as e:
        print(e)
        print("failed to create executable file for verify.")
        return False


# set_up_dilithium()
# key_gen()
# 
# sign("hello world!", "85e61fc075c229d032c1d67bf22cbe1133dc1a1775c42da9d10940517fa5d25ec543b406f9254f24fd7f90ada773eeaf383fb3a91f54d8933960fac79eb5aebf5ba90e3077362d5f754158897434f751674028c61e294e1669a1d66a35829a457fbead28f02437da10c598ad0bdff026d896a1af20b7a4ebc8a1ccaa228d64f85c18248a4632a1304099162e12379109a648800061c4b0700400882231451c110c0ac3688a420c83a62dc9186c03c5450a10218bb01108c90c92c86d08480a5390451b816809c6501029645098511a17898b428064140852042d01b4101a408188c4800c834cc9988013082d0c0350c046315b38061c459018a14c180084a3a281d2002a43b46ddca40019b3210030301a863014466cc41490e4a825d8280e89342e5b341048402c0b330154c6819228680b078ac8c68dc4344d60106060866ce2362aca422adca24d1a2312084132d2004104884914090924880849c86012048a5b365004336103b348201645cc84091c124c140744d2908113034c23a0488c488212c829640410004611190986180448c4b48dcb324e9a266e10352ee2242ec4a6404a8630a19609a242044810241b034150100664307251362a82402d8b24404826444348309c463223254a01124909298e64c66421b56c1341610b244d88c02c91328d0a3529a3402554420549b00511976000198243a64d20268440184d92b4659b185098a68011c32c042870c3926c2046669c48811b022c03b02d5a488ea444450ca491d0b260dc02400c984cd248688224811344654c324190968011262c23360a00158809174ea3342c50380dd94472cb462a62c288809621d3140513b64121c42011b56508826120204e58480e8b20220a424e1ac56143b891a1964994b8114c10850186802219458bc2704ac66d8b2086c2b624a0160661b66d9c0042cca00141a4500c148c5b30858926295ab290d1222a9b121082a06099a24da2480e09455054926493082d4902865c1465589625949685a4046e4a1405d2462123866899124801c0901991892009210ba54d110950a1a06c921441091942c90271134111448651101908542285932472cc34080217609bb4690b438d503824234405898651e2380601386813950dd20811214902c14688239570a0c610808031d2902c1b0850d9864dd3346c0cb48459b82c1a108909048248c8444404805036250b2831caa64893b6442489894c4651e3a241222528d08208419409c1104c5d8ca7b575b1a1558ac52b5a9304b76b2b328d7bf946f16099972f18b9aa18c3f2b12d4bac89a8e0c7f8ad95c7018230c14a9898c64f69203fc2079701cff4bd1ae939c3b4213449113f1b00cc8ef45051bac82c3fbd55eba4fe410c0e786a41c5f2b64021585c4f8ab35713758fd02ea0a661dd0478dfa7649850b3d9a3223d0c3198d8eb9ea45829bd00a8b4204fcb457babc9be4656eeabfe93233f548853878fb96ed131f51ffd3e4de7c2288043b16bf7a92858bfdb1f6b318b5f4e65c313c1130c5ddb6414c44586fd89d6d4a93f9c3f0e2d79fb6c7635d824333d0cab25f87707a58c28ce716a0bca1c121f56cb8e6f2d966c64dede45d3845cfe9589d90f3dedab2fc604fe19f23de1eb4eb4a4312c05260843d430f38fb66ab2f9e1acb16ab22739aa91ba284ab3bbd4d07606cb2c60d2077fb4140b25d5a6912648eb024ddfea94e808992a4dcbc9827d751b42eb23ef83df3d39e19a6b3bd7a5a895f4db9e178f71d9fd22c13d40a8187500d76d980e1f7314147be3e02dde19bd0d438a789a5b1c4ed2584a6b949b9f9a5a3dd9b0e20253a735e63a807eb807930bbf21a8cb6488a7e205f04c8d0c14ad7928c0eb2481c65ec6de79e8c6faa8244b1e3a2968618393e8581e4e0b1c26d79c361176f04ea8ac1d847375b3d0b0562f48d51685b45c65cd17d2d4a8e144f993d553aac17ca913f3650ffb0fd1dcd8fabda93ca4d0c740f870e14dbb560385ae52ad0e60cc9bc69b877e6cf9e76d131554aaccaa2bc5698bf64781e29c2288cf138c04f00ce09e1ed2daf2d62218092cea5750d75bec966cd5e31026a1335ee62f02079d9fc36c61f5e682533c88e1ff059a757485a5182546b763e52078d0b70b283bd6bc50f4e7f6fcfaca9fee5ecae8a4e946597543a61468ba48515ac35cda3e71adf46293f7b176b01f37dea2ed1a14ab861a1d68c0d6a096b1defda0d9e25f8195df4682bc941285a0b1824ccc94f29fefe20ab5c5dabb6522bf11ba92d0f429ce2b69a9959047d434beac8d84c8820fbbb9ac5313a71b54654bf184fbc6ba2ff0c2ef49cada8ad09d7ce7a78a141a3d5f791e6ff79bf5a343d790f24c32fa05658e1b1f71abe79fb6eba1695b9165d347433ca8b45c5ecafff9173319deb6f6cd0a2d39fe1124339c869bc13b0f3a460a6c4c7261da2cbad4b04c5d08a11f4f09889054d1750db3e71d058f23cda934061b6f498e68cb4ce204815684477c5fd23269731d957c90b28802d51621b068e8828ed49f4270bfb6f5374b6094762e1464298eecc0e77a0da4272a3cb9f59bdbeb5b6657a9f7a9de4bd70eff7480d704cead30c4d2fb55383d97291a321dcbbbf8b7823bb5810190069cc035d4a7c26346b491d8b051bf34f44d60e378f540b5295ceee5089ab560c966d95691410e4fee5a3ca0273b09b69c1ea41c351c2645e17b6a4f15f417f5c16c067be7ee139db7d2de04688773d3205b80be4210aa1263380265c42b14c3af681696b59c9b913a6a06cc070e00f8a9c705a4249d794b4e2e41d12499d8f489e1272d3395428fc11aff0276a977aaa42e8933670454696dc757fca1b994637857c31987c6fd3fbad6f1b08ab7407a19eaf10a313d1eef9b27e4daa2f0e3f7aaea9380ed719c7552cb2f8eac962a150c849399c2610cec2e7bae39b454ae399b12f13424e1e1eb996f45da954eba13e7f18e76a73fff4cae846d5c5f086b5a96e5426f9865649b4f1a4ed35fb67285ce4b4676faac9153465d13f730ec5f3d5dbdbe94dad45b06638560b238852ce30b882284ea1e3293b322854b2eb6a3c86735aa9216baa881d863f258f15894ce6f6c54dfb3ff3eece8d632cd2a7dad57eea554c370e88ba1f2a55185d1de743061c28f4727364b5d9da51d22157795493d88e3d9f5a193bf8d5a3b0be38b6d18af0c2ce96bdf29a1865ab4997a6db17716cb6a08212f2255c54df52cd50882160c1907943ee1b22b5e6f662d2d81296ecbb57f6626bc2b771cdc0c4a770fc1351920bcb617c10538facf35c507000a73224017da61831bc3124b3053c89bc350a19bae2f39cc69c8c78745d41669378f05b645d81b57037cc9263099ddc16d8970837d0b1dc0b8b2dffd6386bba10eec4c51ec475f6559bb03f12c4a3e2999e4acdb6505093695624a2612b709ae965bc8c10320cf7815de4d0223d328e1a513c1adb9f1ed9d5a19241ef3e0c7571fa2138f156ad24ae58040c30f08a9811ef2135c62ea370710438813d906083c6e3df17927ede3f1d358ca4f5eda00e2dbc7ce65b717314cae41cb83c99820a97b0ee19e2e7c9a805237a4db673632aaab39f758bf")
# verify("hello world!", "08c012d6cab7b7ecbde19b88e7bf0131941c7049db26835e42942685e8c78b5acb4e7d1a9f82d7fb4f50f0fbcb0af84c5afd725c556bbe5df7b20b40ea4c828c5da55ffd12d2c2bfa89ffa4629b0035d1f8500fdfcd18fc373e8b1ae6368b47e2044385b1e8d3fd77f623705b65253010647def133c057599f4267f7065a506757c65ab87c33d403a308268eaf1f783fa2a3e7c68e0963cb20329aa0145aedf0e80d4c5ff8696e647fe250cbdbb8a25347c42f06f63f42c1ed8ab2dd3bdfb175c25916dfd48bb7dff9c000c70c2d137251714445195d98423bb1f3824b55eaf93ed7bd6c9c47bf7ff70912a6203845f036dacb45674511801629071c8d69777816839e4e7fdba4377216eb84475edd45e721a8d0fa056fb5a9b770bd95ae7332e1374fd3cd4fa4cbd5ffeb0a18d579a8000d7af10046e5ea0b00182abff108eb7b383cd6b5d224829ff105b9a558af9becdcb9c37155f72789c0331e4c20ef3d4786cebd46ce584c7f8959c5fcdc42fda105eb1579117f857ded606aaaf62315a87e4308c8f3e20807af039e9c9123dd7bc9a0eaabc5031cd988aed8914882668b6d593e524863909a84082d074939680cf35f879d8777725efb5380d2d011bc032321bff41ccef18a0c851a66f2a8c60a1a023783025d364f3cbab5d90f2e322e4c3cb99dcbbed4022bdd6f127c6fb3e9ae3c4680799da440c608d6644a2384242de670a352ad116560b6c46477d88b91cbfbf4b1dcca7599d8c44ec73a3cb8a766bd8fe0995b07adcd712543caac742e08baaa5e09ca1d93afdef7256980f77c50ec68aaf67fa4d2cdb1fc1c74b2288bf6ce1a234786cf1270a58ce377a70fd8c0ebba00e218643ada715cc31d4b84c205457041d5fe54abd484c33c24acc7672c22cb7c4df5a897ab22e028f04c327d228e06fa441b0d649d3167a0f0946ad0e472ad976c8cd173081a9bf8b3207688f8210ce838cf7b8d76593a58c573782cc6dcc9d88ebcb73214ce1442e5d5edb8c3d208b28906dc64e36a37f1ce563ac783520c960a38f1dbc54d1f8f78280fd5382d5bce347ab0de9fd67faf91c24c2211e8ca3bce07934e9d657122655f7f014fb241227cd616e84748dce24c582319840b575dade620f64ac66a3f58576352e44a12166dface9825caef29fe05cd3ac4825f2c489d6b104e8b40feedd404da6ca2d6d4e3379bf2c47523b279b26e4e68f37890f466b6cf1af32eb87f2723101f85cfca5fe9cea171e0ba49d810432f67eab7b9830f77ee6153c11d113762a60f843b7c0522b2ef9e255a8aece6aec2d290eb42d17fd9bd0e8ca95a198b73a8aeeae94d1b2f540538b359d64bf65dee94eee0d9ed022e2f30fc4d8d5381d79e494e1ca767169c33442275a7abf5facb8828d887f71df70bcbd4d2242d910d1e4805f16d25caf6b5cd998c2321fae0cd5ccfc80e932d588698154aa64dd147bd9e03e8e143cfc3d7edf7bfb7dc84fc0a3fe8bea693cd696f6291de88f1f48f3af2f5123b51a8de1e11b1e91083103942ffda29d51ead9179e659f9fa0cf94ba010a715d504a4abc5d3f9157a0e248bdb7c816656b4737073a1e9147cec7fce196fb2d757d95a25ddf16da24cf5d0708ff5b3091e43b1d41661a74233b491515546120c89e486eba7762556ab0558ba66ad216ddd65943449651d97c1f003316b39fa448430f8dd37248bc01d5aaea84e4e1e819d94aeee214b4bc336252c4e6d29fbf3041e4785a662d7d4969b0523d895bbd5d702c0b19bcab4dd394b3c190cfa22fcf92a0e871e5c6dc0a45f6b37725bad61b972feecb6e8d69e9a555792f80cbbfaefbdd39d04d1f165101e9b954da7b3994485bbe53dac0917c5ab0343c7233f8e119f3438b4602ade24f6f47a1dc6553f811060306794d62d233c3881fdd6b5afa6b4d3483918f7e7ea23bc0a21498dc1535ed2a680a86aebf2bf51ee2086d8c5d723812dd2528319ebd5665bd3c2991e8cd27f6bde747b9f15b5006f0202def96e5236aebafab247179bec2d637b5d34fe118be84fb07bc8c553b9a2531efc8415f5280823fcc61864b063b238308c4d9d4d40ddbee26efa6cc37ae95ad741c9bd4966d591a0eb8fe281aecb7fed3e66b85028a99179339a50c36808c07ce30d46f124b38053595f5685710506f77eda3416c6e3f7fc2219da8ba17bbc8949ac34e038bf465edad46e817735b8972e8ba8db4c12ccc6909f2a2ec9810eeaf8a6ee83c38d1c5c18d0333122f5e225be416e417f8eb1071bbde7be2f2b5fa0245d98a9b4bd5e234ef8b1495064eccf5a63ced8a0e07a935e0348c1b6393ca271f1cd7a5af86cc9585ec750ec3162b787aa0d83011a1c4d770373eb12dcfd47cc4c3f7f9342ebdd1b3e045a2a360c4a466d46f169aa0cccbf3c0a2822ad014f68f4392f4fa2e663babc6f20b5acdffa1ac1109f88e5af95e1eefbfa58255a59e2a56d016ba53798d113ba3500fbc20d237ef4b6900709d792c3672972fa03eac7210e3fb9cd8f73881367836a74a151e875e8c135a819bd938301134d938ca3e025d904ad100a3af7800a72fe1b81f2d30e982d178c10627dc3d6e20797b0c3ec37a91d6ecaf2c28acae13801ef30a64fa4030b32641180f1b693ec48055baabf80d5fa959577becb4661cfb7424f0da46f9145076b903559bfab1f38c643a21e8e515f0be09177eb6fef2a2c893eef8e3c43e84a5b83670763807c47397a953f8b09d391f7cbc57443499a315b91240fd34822cd19e2edc8444c3e924dc2dbd58bf637f8dc7d83b51ee9eecc6cceeb0fc064638fb6db352c0a27f67af925411d6428b901f417fc4802ea7dd9aeafad71692faf69c1999bf7047c2f02a9df40585e63a2534f14c91e28dde18f2532d38d625baab04ba0e0877a6ed8b116a6cec4f659a951b206a7b42a9d26a4c6ba0c1639034c2c937371bfc1d4e5b3f20915839f994d10aed200720b6aa80ea8e9e241d5e4b4acced9ba09ac45273de195cf3d777fa34e967ed64d324ad9a19febd321741ab3cc4917e7771aade75874127479f38fd96389c904bac9e8361d6247d0b8d6f53302b6acb61364ad7a76cba5ba5f626ddd7daed293b47e5f8bb0b6b5af458239981204849eaf2c572811143b6c545a3d00bf9353ff5f930c63e77db5aabe8b63727654528ab5dfaece36813871f3dbd7ae453f57b31324534114070196f010993b351dc055ae56c6d3894725b96c114bff23542d61b44bdad69ef435c545e4d4ca7509827f4b8c27f313d6e43400c7d0f16fb79fa5f723c2a5cd232b484e51596f727e9cd2eef5050a133259687c7d9ca0b4b5c3c4ccd0dde5f1fd030d1529657f828a92999eb8e6f0fb010e2231464a4c53566a7b8f9098a5a7a9acb9dce3e4e7000000000000000000000c202f46", "85e61fc075c229d032c1d67bf22cbe1133dc1a1775c42da9d10940517fa5d25efc6fbad83203bbde3322a33e31f6b106f3354d9ee6019e070e0f6dfd0d0d7b21914a181f49d915ef3babe2b0e1b4e056393c56959f48ba315539501473038de84682a1f85fac89db63ca50ff466f25dbfa82cf73c53711e07947af50336d466a7fd97068aba2bb181d9440982c20c7ee7607a8cd08ebdbb9cca8c9382e3fc82bb14ab6c39b84306bc0e943ea3e653454626dfa7185fed395031f5280b71a4201e90906bb658453e470449382bd6a5faef876fcaa529e12a8b213b4ce0e160b1c7b739ab8820b423682123d68ccdb77a8d2ba945f9af5895a42b1c11b487251aff0067ee6397a132a9aa9ca02fff0274f4882b29d0e80cdce78a533aedb5505ab18fc3ba553c0c3c2244215ef1735849aa1fb6adf7e6035daf548f50c0e2c3088123b8aeefa774c9a28cd57f89c943d1b817230614f98e9960b17426f313dcdf700bdb6ee4fd20571d7dbdb89c017535fb0382245cc64e8c4c2e924b3659d08700feb30ce769ac3d1516a26627044247ddb4a0c6b6dd43afc37931886936a0a257a059318fe66de195030356e0fb168b951ad93265bc221bbaef5eace19d4664b338ff0b5ea394a5c57007aa1ad5f879ad12f353d878f24e6a6cf146da2da3fc7b22f1b841dc74eb70eb835eefeff974f194fa2b4f7f0f79614afe786509b54637cadbe805d9df12090b6e7e9b9b528e409a92330427b9db15d5bf7ca4b170fbb7d1c662c34cc4bc38f7c2c4ca0459ca1ed3fe17bcdb0da7410c115745836ff03e60d54c222173df209340aef956aee429d04ffd23b27a1203160f059abb2300c9690e80a9e9925c14276a09297089009a6ea3dcfec0b2e1a34c3a2cd4bd6c6ba65241981df66a9201ac3962bf0677bc7986bac19387ddb53f761183d6d34ffdb5352ab41cf99961ef7fbc7840606362c7b7a00094df9aa763207dd765cb173af4e565c6133b5d93e4b5cca2dcaaecf36642243adf27be88b8fb49153fd0bf99832958e499f7fabebd7295df1fab7dbee3702d779ae33c84a65a15aae768c430cf10d856526e1d8cf2c6b7f9de3f632f9f40d6d39c245e1f5f545823bde6c34c69bb1c84273c3686e60f6b245d3c958056c1ee7e6188928df92f29b16ba2735f51db9283a600d904c4b080181d6c0d114e57f8de96b04771ce6f99573b5a642645904433898b23d5eea8cccc818f888bf93b9060c6b6b0199038be9e1fbfe5cd835e768a78c72d73187ecba37d6a65cf2ffa521c942ac28809351f1b58a762e5fdc428d3e0ecfec42f4fff91a7385280e8d926a98e4d7d041be17cc85f43d5aa4ea003eede4615c7cf81e936bb69691715d2f06c97f5b54872a953fa114d8819a4a7cca0a7a84ed68ead7f9d1539d021eab1017a8b3a3a2208d6a21803742c5642baf63e3ef7efccaef2c2ccea02775d4caa23bac56b75fd9deab2e458bc424e46549bf6419a9c72e0989defd6b15a61a35f6e38cfa4d1e552499ff21ee673b8a017b3d2a761725c898ac60e876d2ff8055bf2caf5e3e7962b1eb144e0fb467db981c2fd8010fa95913356ad074164df7a90e4e2b8f42fcee9fb9d8bbf0a3a0599419787a95e79dbcea6a77d322c17d5cf587e67fc8809bcdb26d3adcb9352fcae7affc4ed4fedcd5d3e50100f2ae3894d6fe4706667fda7e8b23c5f80f536e39dbbd56ae6f6599c5ef73fffbd7fe9145a72b38c82fd2d48b77709fd6e36d89da13c0ab1b77b83982ba9f7ce6a7fdd5685c5de22486544464b76fb121aab4a145a7951cd86b13516ae4fa16a4a6f67d2aa1e4cb5c69712ebdfc631a745d62f9c7")